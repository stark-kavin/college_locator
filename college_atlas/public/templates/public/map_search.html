{% extends 'public/base.html' %}
{% load static %}

{% block title %}UniDiscover - Map View{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<style>
    /* Custom scrollbar for the list view */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
    }

    /* Map pattern background simulation */
    .bg-map-pattern {
        background-color: #e5e7eb;
        background-image:
            linear-gradient(rgba(255, 255, 255, 0.7) 2px, transparent 2px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.7) 2px, transparent 2px),
            linear-gradient(rgba(255, 255, 255, 0.3) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.3) 1px, transparent 1px);
        background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;
        background-position: -2px -2px, -2px -2px, -1px -1px, -1px -1px;
    }

    /* Pulsing animation for user location */
    @keyframes pulse-ring {
        0% {
            transform: scale(.33);
        }
        80%, 100% {
            opacity: 0;
        }
    }

    @keyframes pulse-dot {
        0% {
            transform: scale(.8);
        }
        50% {
            transform: scale(1);
        }
        100% {
            transform: scale(.8);
        }
    }

    .my-location-icon .pulse-ring {
        border: 4px solid #3b82f6;
        border-radius: 50%;
        height: 40px;
        width: 40px;
        position: absolute;
        left: -14px;
        top: -14px;
        animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
    }

    .my-location-icon .pulse-dot {
        background-color: #3b82f6;
        border-radius: 50%;
        height: 12px;
        width: 12px;
        animation: pulse-dot 1.25s cubic-bezier(0.455, 0.03, 0.515, 0.955) -.4s infinite;
    }
    .leaflet-routing-container {
        /* Hide the turn-by-turn directions */
        display: none;
    }
</style>
{% endblock %}

{% block body_class %}h-screen flex flex-col overflow-hidden{% endblock %}

{% block content %}
<main class="flex-1 flex overflow-hidden relative">
    <div
        class="w-full md:w-[45%] lg:w-[40%] xl:w-[35%] flex flex-col bg-white border-r border-slate-200 z-10 shadow-xl overflow-hidden relative">
        <div class="flex flex-col border-b border-slate-100 bg-white p-4 gap-4 sticky top-0 z-10">
            <div class="flex justify-between items-end">
                <h3 class="text-slate-900 text-xl font-bold leading-tight">{{ colleges_data|length }} Universities
                    Found</h3>
                <span class="text-slate-500 text-xs font-medium uppercase tracking-wider">Map View</span>
            </div>
            <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar scroll-smooth">
            </div>
        </div>
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4">
            {% for college in colleges_data %}
            <div onclick="focusCollege({{ college.latitude }}, {{ college.longitude }}, {{ college.id }})"
                class="group flex flex-col sm:flex-row gap-4 rounded-xl bg-white p-3 border border-slate-200 hover:border-primary/30 hover:ring-1 hover:ring-primary/10 shadow-sm cursor-pointer hover:shadow-md transition-all"
                data-college-id="{{ college.id }}">
                <div
                    class="w-full sm:w-24 h-24 sm:h-auto shrink-0 bg-slate-100 rounded-lg flex items-center justify-center text-primary">
                    <span class="material-symbols-outlined text-4xl">school</span>
                </div>
                <div class="flex flex-1 flex-col justify-between py-1">
                    <div>
                        <div class="flex justify-between items-start">
                            <h4
                                class="text-slate-900 text-lg font-bold leading-tight group-hover:text-primary transition-colors">
                                {{ college.name }}</h4>
                            <p class="text-slate-500 text-sm font-medium text-right shrink-0 ml-2"
                                id="distance-{{ college.id }}"></p>
                        </div>
                        {% if college.university %}
                        <p class="text-slate-600 text-sm font-medium">{{ college.university }}</p>
                        {% endif %}
                        <p class="text-slate-500 text-sm mt-1 flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">location_on</span>
                            {{ college.district__name }}, {{ college.district__state__name }}
                        </p>
                    </div>
                    <div class="flex justify-end mt-3 sm:mt-0">
                        <a href="{% url 'college_detail' college.id %}"
                            class="text-primary text-sm font-bold hover:underline">View Profile</a>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-10 text-slate-500">
                No colleges found with coordinates.
            </div>
            {% endfor %}
        </div>
        <div class="p-4 border-t border-slate-200 bg-slate-50 text-center">
            <button
                class="text-sm font-medium text-slate-500 hover:text-primary flex items-center justify-center gap-2 w-full">
                <span class="material-symbols-outlined animate-bounce">expand_more</span>
                Load more universities
            </button>
        </div>
    </div>
    <div class="hidden md:block flex-1 relative overflow-hidden h-full">
        <div id="map" class="absolute inset-0 z-0 h-full w-full"></div>

        <button id="use-location-btn"
            class="absolute bottom-6 left-6 z-[1000] flex items-center gap-2 bg-white hover:bg-slate-50 rounded-lg shadow-lg px-4 py-3 transition-all border border-slate-200 hover:shadow-xl group">
            <span class="material-symbols-outlined text-[20px] text-slate-400 group-hover:text-primary">my_location</span>
            <p class="text-slate-700 text-sm font-medium whitespace-nowrap">Use my location</p>
        </button>
    </div>

</main>

{{ colleges_data|json_script:"colleges-data" }}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const map = L.map('map').setView([20.5937, 78.9629], 5);

        const streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        });

        const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        });

        streetMap.addTo(map);

        const baseLayers = {
            "Street Map": streetMap,
            "Satellite View": satelliteMap
        };

        L.control.layers(baseLayers, null, {
            position: 'topright'
        }).addTo(map);

        const collegesData = JSON.parse(document.getElementById('colleges-data').textContent);
        const markers = [];
        let userMarker;
        let userLatLng; // To store user's location
        let routingControl; // To store the routing control

        collegesData.forEach(college => {
            if (college.latitude && college.longitude) {
                const marker = L.marker([college.latitude, college.longitude]).addTo(map);
                marker.bindPopup(`
                    <div class="font-sans">
                        <h3 class="font-bold text-sm">${college.name}</h3>
                        <p class="text-xs text-gray-600">${college.district__name}, ${college.district__state__name}</p>
                        <a href="/college/${college.id}/" class="text-blue-600 text-xs font-bold hover:underline block mt-1">View Details</a>
                    </div>
                `);
                
                marker.on('click', function() {
                    if (userLatLng) {
                        if (routingControl) {
                            map.removeControl(routingControl);
                        }
                        routingControl = L.Routing.control({
                            waypoints: [
                                userLatLng,
                                L.latLng(college.latitude, college.longitude)
                            ],
                            routeWhileDragging: false,
                            addWaypoints: false,
                            lineOptions: {
                                styles: [{color: '#3b82f6', opacity: 0.8, weight: 5}]
                            }
                        }).addTo(map);
                    } else {
                        marker.openPopup();
                    }
                });

                markers.push(marker);

                college.marker = marker;
            }
        });

        if (markers.length > 0) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }

        window.focusCollege = function (lat, lng, id) {
            if (lat && lng) {
                map.flyTo([lat, lng], 12);
                collegesData.forEach(college => {
                    if (college.id === id) {
                        college.marker.fire('click');
                    }
                });
            }
        };

        document.getElementById('use-location-btn').addEventListener('click', function () {
            if (window.isSecureContext === false) {
                alert('Error: Geolocation requires a secure connection (HTTPS) to work. Please access this page over HTTPS.');
                return;
            }
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    userLatLng = L.latLng(userLat, userLng); // Store user's location

                    if (userMarker) {
                        userMarker.setLatLng(userLatLng);
                    } else {
                        userMarker = L.marker(userLatLng, {
                            icon: L.divIcon({
                                className: 'my-location-icon',
                                html: '<div class="pulse-ring"></div><div class="pulse-dot"></div>',
                                iconSize: [12, 12],
                                iconAnchor: [6, 6],
                                popupAnchor: [0, -6]
                            })
                        }).addTo(map);
                    }
                    
                    map.flyTo(userLatLng, 10);
                    userMarker.bindPopup("Your Location").openPopup();

                    collegesData.forEach(college => {
                        if (college.latitude && college.longitude) {
                            const collegeLatLng = L.latLng(college.latitude, college.longitude);
                            const distance = userLatLng.distanceTo(collegeLatLng) / 1000;

                            const distanceEl = document.getElementById(`distance-${college.id}`);
                            if (distanceEl) {
                                distanceEl.textContent = `${distance.toFixed(1)} km`;
                            }

                            // Update popup
                            const popupContent = `
                                <div class="font-sans">
                                    <h3 class="font-bold text-sm">${college.name}</h3>
                                    <p class="text-xs text-gray-600">${college.district__name}, ${college.district__state__name}</p>
                                    <p class="text-xs text-gray-800 font-bold mt-1">Distance: ${distance.toFixed(1)} km</p>
                                    <a href="/college/${college.id}/" class="text-blue-600 text-xs font-bold hover:underline block mt-1">View Details</a>
                                </div>
                            `;
                            college.marker.setPopupContent(popupContent);
                        }
                    });

                }, function (error) {
                    let errorMessage = 'Error: The Geolocation service failed.';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "Geolocation request denied. Please enable location permission in your browser settings.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "Location information is unavailable.";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "The request to get user location timed out.";
                            break;
                        case error.UNKNOWN_ERROR:
                            errorMessage = "An unknown error occurred.";
                            break;
                    }
                    alert(errorMessage);
                });
            } else {
                alert("Error: Your browser doesn't support geolocation.");
            }
        });
    });
</script>
{% endblock %}

{% block footer %}
{% endblock %}